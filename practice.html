<html>
	<head>
		<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
		
		<script src="scripts/util.js"></script>
		<script src="scripts/tasks.js"></script>
		<script src="scripts/taskDisplay.js"></script>
		<script src="scripts/taskGUI.js"></script>
		<script src="scripts/taskSaveLoad.js"></script>
		<script src="scripts/timer.js"></script>
		<script src="scripts/metronome.js"></script>
		<script>
			var contentP;
			var counter;
			var timerLabelElement;
			var tempoLabelElement;
			var taskGUIAreaElement;
			var timerTempoLabelsElement;
			var pauseButton;
			
			var audioStart = null;
			var audioEnd = null;
			var audioMetronome = null;
			
			function onLoad()
			{
				// obtain ID'd elements
				contentP = document.getElementById('contentP');
				counter = document.getElementById('counter');
				pauseButton = document.getElementById('pauseButton');
				timerLabelElement = document.getElementById('timerLabel');
				tempoLabelElement = document.getElementById('tempoLabel');
				taskGUIAreaElement = document.getElementById('taskGUIArea');
				timerTempoLabelsElement = document.getElementById('timerTempoLabels');
				
				// set up timer
				timer.setLabelElement(timerLabelElement);
				
				// obtain audios
				audioStart = document.getElementById('audio_start');
				audioEnd = document.getElementById('audio_end');
				audioMetronome = document.getElementById('audio_metronome');
				
				// set up metronome
				metronome.setAudio(audioMetronome);
				
				// add key listener
				document.addEventListener('keydown', onKeyDown);
				
				// set up task GUI
				taskGUI.setContainerGetter(function(){	// Adds a div to the GUI area and returns the new div
					var ret = document.createElement('div');
					ret.className = 'taskGUIPart';
					taskGUIAreaElement.appendChild(ret);
					return ret;
				});
				
				taskGUI.readTasks();
			}

			// ADD TASKS
			var myTask = {meta:{}, properties:{}};
			
			// SINGLE STRING STUFF

			// Five-Note Patterns
			myTask.meta.name = "Five-Note Patterns";
			myTask.meta.description = "Single-string five-note pattern using $picking.";
			myTask.meta.time = 90;
			myTask.meta.timeBreak = 30;
			myTask.meta.tempo = 80;
			
			myTask.properties.picking = ['alternate picking', 'legatto'];
			myTask.properties.repetition = [1, 2];

			addTask(myTask);
			
			// Single-String Septuplets
			myTask.meta.name = "Single-String Septuplets";
			myTask.meta.description = "Single-string septuplets using $picking for two minutes.";
			myTask.meta.time = 2 * 60;
			myTask.meta.timeBreak = 45;
			myTask.meta.tempo = 80;
			
			myTask.properties.picking = ['alternate', 'legatto'];
			myTask.properties.repetition = [1, 2];

			addTask(myTask);
			
			// ALTERNATE

			// Single-Mode Scales
			myTask = {meta:{}, properties:{}};
			myTask.meta.name = "Single-Position Scale";
			myTask.meta.description = 'Alternate picking ascent/descent in $mode mode.';
			myTask.meta.time = 2 * 60;
			myTask.meta.timeBreak = 45;
			myTask.meta.tempo = 95;
			
			myTask.properties.mode = ['Ionian', 'Dorian', 'Phrygian', 'Lydian', 'Mixolydian', 'Aeolian', 'Locrian'];

			addTask(myTask);
			
			// Seven-Mode Runs
			myTask = {meta:{}, properties:{}};
			myTask.meta.name = "Seven-Mode Run";
			myTask.meta.description = 'Alternate picking seven-mode run starting on $mode mode.';
			myTask.meta.time = 2 * 60;
			myTask.meta.timeBreak = 45;
			myTask.meta.tempo = 80;
			
			myTask.properties.mode = ['Ionian', 'Dorian', 'Phrygian', 'Lydian', 'Mixolydian', 'Aeolian', 'Locrian'];

			addTask(myTask);
			
			// LEGATO
			
			// Single-Mode Legato Scale
			myTask = {meta:{}, properties:{}};
			myTask.meta.name = "Single-Position Legato";
			myTask.meta.description = 'Legato ascent/descents.';
			myTask.meta.time = 2 * 60;
			myTask.meta.timeBreak = 45;
			myTask.meta.tempo = 80;
			
			myTask.properties.repetition = [1, 2, 3, 4];

			addTask(myTask);
			
			// RIFFS
			
			// Facepaint 7/8 Riff
			myTask = {meta:{}, properties:{}};
			myTask.meta.name = "Facepaint 7/8 Riff";
			myTask.meta.description = 'Facepaint - 7/8 Riff.';
			myTask.meta.time = 2 *60;
			myTask.meta.timeBreak = 30;
			myTask.meta.tempo = 170;
			
			myTask.properties.repetition = [1, 2];
			
			addTask(myTask);
			
			// Facepaint Chorus Riff
			myTask = clone(myTask);
			myTask.meta.name = "Facepaint Chorus Riff";
			myTask.meta.description = 'Facepaint - Chorus Riff.'
			myTask.meta.tempo = 75;
			
			addTask(myTask);
			
			// Pest Control Tapping Riff
			myTask = clone(myTask);
			myTask.meta.name = 'Pest Control Tapping Riff';
			myTask.meta.description = 'Pest Control - Tapping Riff.';
			myTask.meta.tempo = 115;
			
			addTask(myTask);
			
			// Pest Control High Riff
			myTask = clone(myTask);
			myTask.meta.name = 'Pest Control High Riff';
			myTask.meta.description = 'Pest Control - High Riff.';
			myTask.meta.tempo = 95;
			
			addTask(myTask);
			
			// Pest Control Sliding Riff
			myTask = clone(myTask);
			myTask.meta.name = 'Pest Control Sliding Riff';
			myTask.meta.description = 'Pest Control - Sliding Riff.';
			myTask.meta.tempo = 105;
			
			addTask(myTask);

			// END ADDING TASKS
			
			function setMetronomeTempo(tempo)
			{
				metronome.tempo = tempo;
				tempoLabelElement.innerHTML = tempo;
			}
			
			// returns true if we are in edit mode
			function inEditMode()
			{
				return (taskGUIAreaElement.style.display != none);
			}
			
			function setEditMode(editMode)
			{
				if(editMode)
				{
					taskGUIAreaElement.style.display = 'block';
					timerTempoLabelsElement.style.display = 'none';
				}
				else
				{
					taskGUIAreaElement.style.display = 'none';
					timerTempoLabelsElement.style.display = 'block';
				}
			}

			shuffleTasks();
			
			function onKeyDown(event)
			{
				switch(event.code)
				{
					case 'ArrowUp':
						setMetronomeTempo(metronome.tempo + 5);
						break;
					case 'ArrowDown':
						setMetronomeTempo(metronome.tempo - 5);
						break;
					case 'Space':
						onPauseButton();
						break;
				}
			}
			
			var paused = false;
			
			function onPauseButton()
			{
				if(paused && currentTask != null)
				{
					paused = false;
					pauseButton.innerHTML = 'Pause';
					
					if(breakMode)
					{
						timer.start(5);
					}
					else
					{
						timer.resume();
						metronome.start();
					}
				}
				else
				{
					paused = true;
					pauseButton.innerHTML = 'Resume';
					
					timer.pause();
					metronome.stop();
				}
			}
			
			var breakMode = true;
			
			function beginBreak()
			{
				breakMode = true;
			
				var nTask = getCurrentTask();
				
				timer.start(nTask.meta.timeBreak);
				timer.setCallback(advanceTask);
				
				metronome.stop();
				
				if(audioEnd != null)
					audioEnd.play();
			}
			
			var currentTask = null;

			function advanceTask()
			{
				currentTask = getNextTask();
				
				if(currentTask == null)
				{
					contentP.innerHTML = 'No more tasks! Click "next task" to reshuffle and start again!';
					setEditMode(true);
					timer.pause();
				}
				else
				{
					setEditMode(false);
					breakMode = false;
				
					contentP.innerHTML = taskToHTML(currentTask);
					counter.innerHTML = '[' + nextTask + ' / ' + variations.length + ']';
					
					timer.start(currentTask.meta.time);
					timer.setCallback(beginBreak);
					
					setMetronomeTempo(currentTask.meta.tempo);
					metronome.start();
					
					if(audioStart != null)
						audioStart.play();
				}
			}
			
			function promptSaveRoutine()
			{
				if(confirm('Are you sure you want to save this routine?'))
				{
					saveTasks();
					alert('Routine saved!');
				}
			}
			
			loadTasks();
		</script>
		<link rel="stylesheet" href="style.css" type="text/css"/>
	</head>
	<body onload="onLoad()">

		<button onClick="advanceTask()">Next Task</button>
		<button id="pauseButton" onClick="onPauseButton()">Pause</button>
		<span id="counter"></span>
		
		<p id="contentP">Click "Next Task" to start!</p>
		
		<p id="timerTempoLabels" style="display:none;">
			TIME: <span id="timerLabel"></span><br/>
			TEMPO: <span id="tempoLabel"></span>
		</p>
		
		<div id="taskGUIArea">
			<button onClick="taskGUI.createTask();">Add Exercise</button>
			<button onClick="promptSaveRoutine();">Save Routine</button>
		</div>
		
		<audio id="audio_start">
			<source src="sounds/start.ogg" type="audio/ogg"/>
		</audio>
		
		<audio id="audio_end">
			<source src="sounds/end.ogg" type="audio/ogg"/>
		</audio>
		
		<audio id="audio_metronome">
			<source src="sounds/metronome.ogg" type="audio/ogg"/>
		</audio>
	</body>
</html>